name: CI Tests

on:
  push:
    branches: [ main, pre-production, production ]
  pull_request:

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: touristinfo
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: touristinfo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node 20 (backend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres to be ready
        run: |
          for i in {1..30}; do
            pg_isready -h "$DB_HOST" -p "$DB_PORT" -U postgres && break
            echo "Waiting for Postgres... ($i/30)"
            sleep 1
          done

      - name: Create test user + apply schema
        run: |
          export PGPASSWORD="postgres"

          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "DO \$\$
             BEGIN
               IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$DB_USER') THEN
                 CREATE ROLE $DB_USER LOGIN PASSWORD '$DB_PASSWORD';
               END IF;
             END
             \$\$;"

          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "CREATE DATABASE $DB_NAME OWNER $DB_USER;" || true

          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

          export PGPASSWORD="$DB_PASSWORD"
          psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f backend/db/init.sql

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run backend tests
        working-directory: backend
        run: npm test


  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node 20 (frontend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: frontend
        run: npm test

      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage


  build:
    name: Build Frontend + Backend (artifacts)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===== Frontend build =====
      - name: Use Node 20 (frontend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: |
            frontend/dist
            frontend/build

      # ===== Backend build =====
      - name: Use Node 20 (backend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Build backend (if present)
        working-directory: backend
        run: npm run build --if-present

      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/dist
            backend/build
            backend/*.js
            backend/*.json
            backend/package.json
            backend/package-lock.json
