name: CI Tests

on:
  push:
    branches: [ main, pre-production, production ]
  pull_request:

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: touristinfo
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: touristinfo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres to be ready
        run: |
          for i in {1..30}; do
            pg_isready -h "$DB_HOST" -p "$DB_PORT" -U postgres && break
            echo "Waiting for Postgres... ($i/30)"
            sleep 1
          done

      - name: Create test user + apply schema
        run: |
          export PGPASSWORD="postgres"

          # Create test user if not exists
          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "DO \$\$
             BEGIN
               IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$DB_USER') THEN
                 CREATE ROLE $DB_USER LOGIN PASSWORD '$DB_PASSWORD';
               END IF;
             END
             \$\$;"

          # Ensure database exists
          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "CREATE DATABASE $DB_NAME OWNER $DB_USER;" || true

          # Grant privileges
          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

          # Apply schema as test_user
          export PGPASSWORD="$DB_PASSWORD"
          psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f backend/db/init.sql

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Run frontend tests with coverage
        run: |
          cd frontend
          npm test

      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

  build:
    name: Build Frontend + Backend (cache + artifacts)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===== Frontend build =====
      - name: Use Node 20 (frontend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: |
            frontend/dist
            frontend/build

      # ===== Backend build =====
      - name: Use Node 20 (backend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Build backend (if present)
        working-directory: backend
        run: npm run build --if-present

      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/dist
            backend/build
            backend/package.json
            backend/package-lock.json
  
  docker:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/touristinfo-backend:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/touristinfo-backend:latest

      - name: Build & push frontend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/touristinfo-frontend:latest ./frontend
          docker push ${{ secrets.DOCKER_USERNAME }}/touristinfo-frontend:latest
  
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Trigger backend deploy
        run: curl -X POST "${{ secrets.RENDER_BACKEND_HOOK }}"

      - name: Trigger frontend deploy
        run: curl -X POST "${{ secrets.RENDER_FRONTEND_HOOK }}"

