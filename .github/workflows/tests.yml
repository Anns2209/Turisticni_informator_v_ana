name: CI Tests

on:
  push:
    branches: [ main, pre-production, production ]
  pull_request:

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports: ['5432:5432']
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: touristinfo
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: touristinfo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres to be ready
        run: |
          for i in {1..30}; do
            pg_isready -h "$DB_HOST" -p "$DB_PORT" -U postgres && break
            echo "Waiting for Postgres... ($i/30)"
            sleep 1
          done

      - name: Create test user + apply schema
        run: |
          export PGPASSWORD="postgres"

          # Create test user if not exists
          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "DO \$\$
             BEGIN
               IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '$DB_USER') THEN
                 CREATE ROLE $DB_USER LOGIN PASSWORD '$DB_PASSWORD';
               END IF;
             END
             \$\$;"

          # Ensure database exists
          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "CREATE DATABASE $DB_NAME OWNER $DB_USER;" || true

          # Grant privileges
          psql -h "$DB_HOST" -U postgres -d postgres -c \
            "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;"

          # Apply schema as test_user
          export PGPASSWORD="$DB_PASSWORD"
          psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f backend/db/init.sql
      
          

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Cache npm (frontend)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-frontend-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-frontend-
            ${{ runner.os }}-npm-

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Run frontend tests with coverage
        run: |
          cd frontend
          npm test

      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

  build:
    name: Build Frontend + Backend (cache + artifacts)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===== Frontend build =====
      - name: Use Node 20 (frontend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      
      - name: Cache npm (frontend)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-frontend-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-frontend-
            ${{ runner.os }}-npm-

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: |
            frontend/dist
            frontend/build

      # ===== Backend build =====
      - name: Use Node 20 (backend) + npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Cache npm (backend)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-backend-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-backend-
            ${{ runner.os }}-npm-

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Build backend (if present)
        working-directory: backend
        run: npm run build --if-present

      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/dist
            backend/build
            backend/package.json
            backend/package-lock.json
  
  docker_dev:
      name: Build & Push Docker Images (dev)
      runs-on: ubuntu-latest
      needs: build
      if: github.ref == 'refs/heads/main'
      environment: Development

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build & push backend image (dev)
          run: |
            IMAGE=${{ secrets.DOCKER_USERNAME }}/touristinfo-backend
            docker build -t $IMAGE:dev ./backend
            docker push $IMAGE:dev

        - name: Build & push frontend image (dev)
          run: |
            IMAGE=${{ secrets.DOCKER_USERNAME }}/touristinfo-frontend
            docker build -t $IMAGE:dev ./frontend
            docker push $IMAGE:dev


  docker_prod:
      name: Build & Push Docker Images (prod)
      runs-on: ubuntu-latest
      needs: [build, sonarcloud]
      if: github.ref == 'refs/heads/production'
      environment: Production

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build & push backend image (prod)
          run: |
            IMAGE=${{ secrets.DOCKER_USERNAME }}/touristinfo-backend
            docker build -t $IMAGE:prod ./backend
            docker push $IMAGE:prod

        - name: Build & push frontend image (prod)
          run: |
            IMAGE=${{ secrets.DOCKER_USERNAME }}/touristinfo-frontend
            docker build -t $IMAGE:prod ./frontend
            docker push $IMAGE:prod

  
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')

    steps:
      - name: Trigger backend deploy
        run: curl -X POST "${{ secrets.RENDER_BACKEND_HOOK }}"

      - name: Trigger frontend deploy
        run: curl -X POST "${{ secrets.RENDER_FRONTEND_HOOK }}"

  sonarcloud:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout (full history for Sonar)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download frontend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

      - name: SonarCloud analysis
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Quality Gate: naj blokira samo production
      - name: SonarCloud Quality Gate
        if: github.ref == 'refs/heads/production'
        uses: SonarSource/sonarcloud-quality-gate-action@v1.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


